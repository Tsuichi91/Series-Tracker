<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Watch Tracker â€¢ Overview</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header>
    <div class="bar">
      <div class="logo"><span class="logo-icon"></span><span>Watch Tracker</span></div>
      <div class="spacer"></div>
      <a class="link-btn" href="dashboard.html">ðŸ“Š Dashboard</a>
      <a class="link-btn" href="admin.html">ðŸ›  Admin</a>
    </div>
    <div class="filters">
      <div class="chip"><label>Type</label>
        <select id="fType">
          <option value="all">All</option>
          <option value="movies">Movies</option>
          <option value="series">Series</option>
        </select>
      </div>
      <div class="chip"><label>Genre</label>
        <select id="fGenre"><option value="">All</option></select>
      </div>
      <div class="chip"><label>Year</label>
        <select id="fYear"><option value="">All</option></select>
      </div>
      <div class="chip"><label>Search</label>
        <input id="q" placeholder="title, tag, genre" />
      </div>
      <div class="chip sort"><label>Sort</label>
        <select id="sort">
          <option value="title">Title (Aâ€“Z)</option>
          <option value="year">Year (newâ†’old)</option>
          <option value="rating">Rating</option>
          <option value="added">Recently updated</option>
        </select>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- 1) Top Rated -->
    <section class="row">
      <h2>Top Rated Serien / Filme</h2>
      <div class="scroller" id="rowTop"></div>
    </section>

    <!-- 2) Ãœbersicht -->
    <section class="row">
      <h2>Ãœbersicht aller Serien / Filme</h2>
      <div class="scroller" id="rowAll"></div>
    </section>
  </main>

  <!-- Series Detail Overlay -->
  <div class="overlay" id="seriesOverlay">
    <div class="panel">
      <div id="seriesHeader"></div>
      <div class="muted" id="seriesMeta"></div>
      <div style="margin:8px 0"><div class="progress"><span id="seriesBar" style="width:0%"></span></div></div>
      <div class="row-body" id="seasonsHost"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script type="module">
    // ---------- Firebase ----------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    async function loadConfig(){
      for (const p of ["firebase.config.json","firebase.config.example.json"]) {
        try { const r = await fetch(p); if(r.ok) return r.json(); } catch(e) {}
      }
      throw new Error("Missing firebase.config.json");
    }

    const cfg = await loadConfig();
    const app = initializeApp(cfg);
    const db  = getFirestore(app);

    // ---------- Helpers ----------
    const nowISO = () => new Date().toISOString();
    const pad = v => String(v).padStart(2,"0");
    const toDDMMYYYY = iso => { if(!iso) return ""; const d=new Date(iso); if(isNaN(d)) return iso; return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()}`; };
    const pct = (a,b) => b<=0?0:Math.round((a/b)*100);

    function seasonProgress(season){
      const eps = season.episodes||[]; const watched = eps.filter(e=>e.watched).length; const total = eps.length; return {watched,total,percent:pct(watched,total)};
    }
    function seriesGlobalProgress(serie){
      const seasons = serie.seasons||[]; let watched=0,total=0; seasons.forEach(s=>{watched+= (s.episodes||[]).filter(e=>e.watched).length; total+= (s.episodes||[]).length;}); return {watched,total,percent:pct(watched,total)};
    }
    function showToast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',1500); }

    // ---------- State ----------
    const state = { items:[], query:'', sort:'title', filters:{ type:'all', genre:'', year:'' } };

    // ---------- Fetch ----------
    async function fetchAll(){
      const out=[];
      for (const name of ["movies","series"]) {
        try {
          const snap = await getDocs(query(collection(db,name), orderBy("updated_at","desc")));
          snap.forEach(doc=> out.push({ id:doc.id, type:name.slice(0,-1), ...doc.data() }));
        } catch (err) {
          // Fallback ohne orderBy (falls Feld/Index fehlt)
          const snap = await getDocs(collection(db,name));
          snap.forEach(doc=> out.push({ id:doc.id, type:name.slice(0,-1), ...doc.data() }));
        }
      }
      state.items = out;
      populateFilterOptions();
      renderAll();
    }

    // ---------- UI ----------
    function renderStars(v){ const full=Math.round(v||0); return 'â˜…â˜…â˜…â˜…â˜…'.slice(0,full)+'â˜†â˜†â˜†â˜†â˜†'.slice(full); }

    function buildCard(item){
      const isSeries = (item.type==='series');
      const el = document.createElement('div'); el.className='card';
      el.innerHTML = `
        <div class="poster">
          <img src="${item.poster||''}" alt="Poster" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 400 600\'%3E%3Crect width=\'100%25\' height=\'100%25\' fill=\'%230d0d0d\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' fill=\'%23bbb\' dominant-baseline=\'middle\' text-anchor=\'middle\' font-family=\'sans-serif\' font-size=\'20\'%3ENo Image%3C/text%3E%3C/svg%3E'"/>
          <div class="badge-bar">${(item.genres||[]).slice(0,2).map(g=>`<span class='badge'>${g}</span>`).join('')}</div>
        </div>
        <div class="card-body">
          <div class="title">${item.title_en||''}</div>
          <div class="subtitle">${item.title_original||''}</div>
          <div class="stars">${renderStars(item.rating)}</div>
          ${ isSeries ? `<div class='progress'><span style='width:${seriesGlobalProgress(item).percent}%'></span></div>` : ''}
          <div class="actions">
            ${ isSeries ? '<button class="btn" data-open="1">Open</button>' : ''}
            <button class="btn ${item.favorite?'active':''}" data-fav="1">â™¥</button>
            <button class="btn ${item.on_watchlist?'active':''}" data-wl="1">Watchlist</button>
          </div>
        </div>`;
      if(isSeries){ el.querySelector('[data-open]')?.addEventListener('click',()=> openSeriesDetail(item)); el.querySelector('.poster').addEventListener('click',()=> openSeriesDetail(item)); }
      el.querySelector('[data-fav]')?.addEventListener('click',()=>{ item.favorite=!item.favorite; showToast(item.favorite? 'Added to Favorites':'Removed from Favorites'); renderAll(); });
      el.querySelector('[data-wl]')?.addEventListener('click',()=>{ item.on_watchlist=!item.on_watchlist; showToast(item.on_watchlist? 'Added to Watchlist':'Removed from Watchlist'); renderAll(); });
      return el;
    }

    function filterAndSort(arr){
      const f = state.filters;
      let a = arr.filter(x=> (f.type==='all' || x.type===f.type)
        && (!f.genre || (x.genres||[]).includes(f.genre))
        && (!f.year || String(x.year)===String(f.year))
        && (!state.query || ((x.title_en||'').toLowerCase().includes(state.query) || (x.title_original||'').toLowerCase().includes(state.query) || (x.tags||[]).join(' ').toLowerCase().includes(state.query) || (x.genres||[]).join(' ').toLowerCase().includes(state.query)))
      );
      const s = state.sort;
      a.sort((x,y)=> s==='title'? (x.title_en||'').localeCompare(y.title_en||'')
        : s==='year'? (y.year||0)-(x.year||0)
        : s==='rating'? (y.rating||0)-(x.rating||0)
        : (new Date(y.updated_at)-new Date(x.updated_at))
      );
      return a;
    }

    function renderRow(id, items){ const host=document.getElementById(id); host.innerHTML=''; items.forEach(i=> host.appendChild(buildCard(i))); }
    function computeTop(items){ return items.filter(x=> (x.rating||0)>=4).slice(0,30); }

    function renderAll(){
      const filtered = filterAndSort(state.items);
      renderRow('rowTop', computeTop(filtered));
      renderRow('rowAll', filtered);
      populateFilterOptions(); // keep genre/year options fresh after changes
    }

    function unique(values){ return Array.from(new Set(values.filter(Boolean))).sort(); }
    function populateFilterOptions(){
      const items = state.items.filter(x=> state.filters.type==='all' || x.type===state.filters.type);
      const genres = unique(items.flatMap(x=> x.genres||[]));
      const years  = unique(items.map(x=> x.year));
      const gSel=document.getElementById('fGenre'); const ySel=document.getElementById('fYear');
      const gVal=gSel.value, yVal=ySel.value;
      gSel.innerHTML = '<option value="">All</option>'+genres.map(g=>`<option ${g===gVal?'selected':''}>${g}</option>`).join('');
      ySel.innerHTML = '<option value="">All</option>'+years.map(y=>`<option ${String(y)===String(yVal)?'selected':''}>${y}</option>`).join('');
    }

    // ---------- Series detail ----------
    function openSeriesDetail(serie){
      document.getElementById('seriesHeader').innerHTML = `<h3>${serie.title_en}</h3><div class='muted'>${serie.title_original||''}</div>`;
      const bits = [String(serie.year||'').trim(), (serie.platform||'').trim(), (serie.episode_length_min? (serie.episode_length_min+" min") : ''), (serie.series_status||'').trim()].filter(Boolean);
      document.getElementById('seriesMeta').textContent = bits.join(' â€¢ ');
      document.getElementById('seriesBar').style.width = seriesGlobalProgress(serie).percent+"%";
      const host = document.getElementById('seasonsHost'); host.innerHTML='';
      (serie.seasons||[]).forEach(season=>{
        const prog = seasonProgress(season);
        const box = document.createElement('div');
        box.style.border='1px solid var(--border)'; box.style.borderRadius='12px'; box.style.padding='10px'; box.style.margin='10px 0';
        box.innerHTML = `<div style='display:flex;align-items:center;gap:8px'><strong>Season ${season.season_number}</strong><span class='muted'>${prog.watched}/${prog.total} eps</span><div class='progress' style='flex:1;max-width:200px'><span style='width:${prog.percent}%'></span></div></div>`;
        (season.episodes||[]).forEach(ep=>{
          const row = document.createElement('div'); row.className='ep';
          row.innerHTML = `<code>${ep.code}</code> <span>${ep.title||''}</span> <span class='muted'>${toDDMMYYYY(ep.air_date)}</span>`;
          box.appendChild(row);
        });
        host.appendChild(box);
      });
      document.getElementById('seriesOverlay').style.display='flex';
    }
    document.getElementById('seriesOverlay').addEventListener('click', (e)=>{ if(e.target.id==='seriesOverlay') e.currentTarget.style.display='none'; });

    // ---------- Filters & Search ----------
    document.getElementById('fType').addEventListener('change', e=>{ state.filters.type=e.target.value==='all'?'all':e.target.value.slice(0,-0); state.filters.type=e.target.value==='all'?'all':e.target.value.replace(/s$/,''); state.filters.type = e.target.value === 'all' ? 'all' : (e.target.value === 'movies' ? 'movie' : 'series'); renderAll(); });
    document.getElementById('fGenre').addEventListener('change', e=>{ state.filters.genre=e.target.value; renderAll(); });
    document.getElementById('fYear').addEventListener('change', e=>{ state.filters.year=e.target.value; renderAll(); });
    document.getElementById('sort').addEventListener('change', e=>{ state.sort=e.target.value; renderAll(); });
    document.getElementById('q').addEventListener('input', e=>{ state.query=e.target.value.toLowerCase(); renderAll(); });

    // ---------- Start ----------
    fetchAll().catch(async err=>{
      console.warn('Firestore failed, falling back to sample-data.json', err);
      const res = await fetch('sample-data.json'); const json = await res.json();
      state.items = [ ...json.movies.map(m=>({...m, type:'movie'})), ...json.series.map(s=>({...s, type:'series'})) ];
      populateFilterOptions(); renderAll();
    });
  </script>
</body>
</html>
