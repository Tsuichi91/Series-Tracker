<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Watch Tracker â€¢ Overview</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    /* Page-specific: compact grid for overview */
    .page-index .card-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill, minmax(168px,1fr));
      gap:12px;
    }
    .page-index .card-grid .card{ margin:0; }
    @media (min-width:1200px){
      .page-index .card-grid{ grid-template-columns:repeat(auto-fill, minmax(184px,1fr)); }
    }
    #sentinel{ height:32px; }

    /* Detail panel layout */
    .page-index .panel{ width:min(1100px,94vw); padding:22px; }
    .detail-header{ display:flex; align-items:flex-start; justify-content:space-between; gap:16px; margin-bottom:8px; }
    .detail-title{ font-size:2rem; font-weight:800; margin:0; }
    .detail-close{ background:var(--chip); border:1px solid var(--border); border-radius:10px; padding:6px 10px; cursor:pointer;}
    .detail-close:hover{ background:var(--chip-press); }
    .detail-two-col{ display:grid; grid-template-columns:260px 1fr; gap:22px; align-items:start; }
    .detail-poster{ width:260px; border-radius:12px; border:1px solid var(--border); background:#0d0d0d; overflow:hidden; }
    .meta{ display:flex; flex-direction:column; gap:16px; margin-top:6px; }
    .meta .row{ display:grid; grid-template-columns:180px 1fr; gap:12px; }
    .meta label{ opacity:.9; }
    .desc{ margin-top:14px; opacity:.95; }
    .panel .progress{ height:8px; margin-top:6px; }

    /* Tabs */
    .tabs{ display:flex; gap:8px; padding:10px 16px; border-bottom:1px solid var(--border); }
    .tab-btn{ background:var(--chip); border:1px solid var(--border); color:var(--text); padding:8px 12px; border-radius:999px; cursor:pointer; }
    .tab-btn.active{ border-color:var(--accent); box-shadow:0 0 0 2px rgba(45,212,191,.15) inset; }
  </style>
</head>
<body class="page-index">
  <header>
    <div class="bar">
      <div class="logo"><span class="logo-icon"></span><span>Watch Tracker</span></div>
      <div class="spacer"></div>
      <a class="link-btn" href="dashboard.html">ðŸ“Š Dashboard</a>
      <a class="link-btn" href="admin.html">ðŸ›  Admin</a>
    </div>

    <!-- Tab bar -->
    <div class="tabs">
      <button class="tab-btn active" id="tabMovies">Movies</button>
      <button class="tab-btn" id="tabSeries">Series</button>
      <div class="spacer"></div>
      <!-- Filters (type filter removed because tabs handle it) -->
      <div class="chip"><label>Genre</label>
        <select id="fGenre"><option value="">All</option></select>
      </div>
      <div class="chip"><label>Year</label>
        <select id="fYear"><option value="">All</option></select>
      </div>
      <div class="chip"><label>Search</label>
        <input id="q" placeholder="title, tag, genre" />
      </div>
      <div class="chip sort"><label>Sort</label>
        <select id="sort">
          <option value="title">Title (Aâ€“Z)</option>
          <option value="year">Year (newâ†’old)</option>
          <option value="rating">Rating</option>
          <option value="added">Recently updated</option>
        </select>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Top Rated (horizontal) -->
    <section class="row">
      <h2 id="topHeading">Top Rated Movies</h2>
      <div class="scroller" id="rowTop"></div>
    </section>

    <!-- Overview (Grid + Infinite Scroll) -->
    <section class="row">
      <h2 id="allHeading">All Movies</h2>
      <div class="card-grid" id="gridAll"></div>
      <div id="noResults" class="muted" style="display:none;margin:8px">No results</div>
      <div id="sentinel"></div>
    </section>
  </main>

  <!-- Movie Detail Overlay -->
  <div class="overlay" id="movieOverlay" style="display:none">
    <div class="panel" id="moviePanel"></div>
  </div>

  <!-- Series Detail Overlay -->
  <div class="overlay" id="seriesOverlay" style="display:none">
    <div class="panel">
      <div id="seriesHeader"></div>
      <div class="muted" id="seriesMeta"></div>
      <div style="margin:8px 0"><div class="progress"><span id="seriesBar" style="width:0%"></span></div></div>
      <div class="desc" id="seriesDesc"></div>
      <div class="row-body" id="seasonsHost"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script type="module">
    /* ---------- Firebase ---------- */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    async function loadConfig(){
      for (const p of ["firebase.config.json","firebase.config.example.json"]) {
        try { const r = await fetch(p); if(r.ok) return r.json(); } catch(e) {}
      }
      throw new Error("Missing firebase.config.json");
    }
    const cfg = await loadConfig();
    const app = initializeApp(cfg);
    const db  = getFirestore(app);

    /* ---------- Helpers ---------- */
    const pad = v => String(v).padStart(2,"0");

    // Very robust date formatter
    function formatDateFromAny(value){
      if(value == null || value === '') return '';
      if (typeof value === 'object' && typeof value.seconds === 'number'){
        return fmt(new Date(value.seconds * 1000));
      }
      if (typeof value === 'number') return fromNumeric(value);

      const s = String(value).trim();
      if (/^\d+$/.test(s)) return fromNumeric(Number(s));

      let m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/); if (m) return `${m[3]}.${m[2]}.${m[1]}`;
      m = s.match(/^(\d{2})\.(\d{2})\.(\d{4})$/);     if (m) return `${m[1]}.${m[2]}.${m[3]}`;
      m = s.match(/^(\d{4})\/(\d{2})\/(\d{2})$/);     if (m) return `${m[3]}.${m[2]}.${m[1]}`;
      m = s.match(/^(\d{4})(\d{2})(\d{2})$/);         if (m) return `${m[3]}.${m[2]}.${m[1]}`;

      const d = new Date(s);
      return isNaN(d.getTime()) ? '' : fmt(d);

      function fromNumeric(n){
        if (n > 1e12) return fmt(new Date(n));          // unix ms
        if (n > 1e9 && n < 1e12) return fmt(new Date(n*1000)); // unix s
        if (n >= 60 && n < 100000){ // Excel serial (days since 1899-12-30)
          const excelEpoch = Date.UTC(1899, 11, 30);
          const ms = excelEpoch + Math.round(n)*86400000;
          return fmt(new Date(ms));
        }
        return '';
      }
      function fmt(d){
        const y = d.getUTCFullYear();
        if (y < 1900 || y > 3000) return '';
        return `${pad(d.getUTCDate())}.${pad(d.getUTCMonth()+1)}.${y}`;
      }
    }

    const pct = (a,b) => b<=0?0:Math.round((a/b)*100);
    const hhmmFromMinutes = m => {
      const min = Math.max(0, Number(m)||0);
      const h = Math.floor(min/60); const mm = min%60;
      return `${pad(h)}:${pad(mm)}`;
    };
    function seasonProgress(season){
      const eps = season.episodes||[]; const watched = eps.filter(e=>e.watched).length; const total = eps.length; return {watched,total,percent:pct(watched,total)};
    }
    function seriesGlobalProgress(serie){
      const seasons = serie.seasons||[]; let watched=0,total=0;
      seasons.forEach(s=>{ const eps=s.episodes||[]; watched+=eps.filter(e=>e.watched).length; total+=eps.length; });
      return {watched,total,percent:pct(watched,total)};
    }
    function movieProgress(movie){
      const status = (movie.status||'').toLowerCase();
      if(['completed','finished','watched'].includes(status)) return 100;
      const runtimeSec = Math.max(0, (Number(movie.runtime_min)||0) * 60);
      const pos = Math.max(0, Number(movie.last_position_seconds)||0);
      if(runtimeSec <= 0) return 0;
      const p = Math.round((pos / runtimeSec) * 100);
      return Math.max(0, Math.min(100, p >= 95 ? 100 : p));
    }
    function showToast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',1500); }

    /* ---------- State ---------- */
    const state = {
      items: [],
      activeTab: 'movies',  // 'movies' | 'series'
      query: '',
      sort: 'title',
      filters: { genre:'', year:'' },
      filteredAll: [],
      pageSize: 24,
      pageIndex: 0,
      io: null
    };

    /* ---------- Fetch ---------- */
    async function fetchAll(){
      const out=[];
      for (const name of ["movies","series"]) {
        try {
          const snap = await getDocs(query(collection(db,name), orderBy("updated_at","desc")));
          snap.forEach(doc=> out.push({ id:doc.id, type: name === "movies" ? "movie" : "series", ...doc.data() }));
        } catch {
          const snap = await getDocs(collection(db,name));
          snap.forEach(doc=> out.push({ id:doc.id, type: name === "movies" ? "movie" : "series", ...doc.data() }));
        }
      }
      state.items = out;
      setTab('movies'); // default
    }

    /* ---------- UI ---------- */
    function renderStars(v){ const full=Math.round(v||0); return 'â˜…â˜…â˜…â˜…â˜…'.slice(0,full)+'â˜†â˜†â˜†â˜†â˜†'.slice(full); }

    function buildCard(item){
      const isSeries = (item.type==='series');
      const percent = isSeries ? seriesGlobalProgress(item).percent : movieProgress(item);
      const el = document.createElement('div'); el.className='card';
      el.innerHTML = `
        <div class="poster">
          <img src="${item.poster||''}" alt="Poster" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 400 600\'%3E%3Crect width=\'100%25\' height=\'100%25\' fill=\'%230d0d0d\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' fill=\'%23bbb\' dominant-baseline=\'middle\' text-anchor=\'middle\' font-family=\'sans-serif\' font-size=\'20\'%3ENo Image%3C/text%3E%3C/svg%3E'"/>
          <div class="badge-bar">${(item.genres||[]).slice(0,2).map(g=>`<span class='badge'>${g}</span>`).join('')}</div>
        </div>
        <div class="card-body">
          <div class="title">${item.title_en||''}</div>
          <div class="subtitle">${item.title_original||''}</div>
          <div class="stars">${renderStars(item.rating)}</div>
          <div class='progress'><span style='width:${percent}%'></span></div>
          <div class="actions">
            <button class="btn" data-details="1">Details</button>
          </div>
        </div>`;
      const open = ()=> isSeries ? openSeriesDetail(item) : openMovieDetail(item);
      el.querySelector('[data-details]').addEventListener('click', open);
      el.querySelector('.poster').addEventListener('click', open);
      return el;
    }

    function filterAndSort(arr){
      const typeWant = state.activeTab === 'movies' ? 'movie' : 'series';
      const f = state.filters;
      let a = arr.filter(x=> x.type===typeWant
        && (!f.genre || (x.genres||[]).includes(f.genre))
        && (!f.year || String(x.year)===String(f.year))
        && (!state.query || ((x.title_en||'').toLowerCase().includes(state.query)
          || (x.title_original||'').toLowerCase().includes(state.query)
          || (x.tags||[]).join(' ').toLowerCase().includes(state.query)
          || (x.genres||[]).join(' ').toLowerCase().includes(state.query)))
      );
      const s = state.sort;
      a.sort((x,y)=> s==='title'? (x.title_en||'').localeCompare(y.title_en||'')
        : s==='year'? (y.year||0)-(x.year||0)
        : s==='rating'? (y.rating||0)-(x.rating||0)
        : (new Date(y.updated_at)-new Date(x.updated_at))
      );
      return a;
    }

    function renderRow(id, items){
      const host=document.getElementById(id); host.innerHTML='';
      items.forEach(i=> host.appendChild(buildCard(i)));
    }

    /* ---------- Grid + Infinite Scroll ---------- */
    function resetGrid(){
      state.pageIndex = 0;
      document.getElementById('gridAll').innerHTML = '';
      document.getElementById('noResults').style.display = state.filteredAll.length ? 'none' : 'block';
    }
    function loadNextPage(){
      const start = state.pageIndex * state.pageSize;
      const end   = start + state.pageSize;
      const slice = state.filteredAll.slice(start, end);
      const host  = document.getElementById('gridAll');
      slice.forEach(item => host.appendChild(buildCard(item)));
      state.pageIndex++;
      if(end >= state.filteredAll.length && state.io){ state.io.disconnect(); }
    }
    function setupInfiniteScroll(){
      if(state.io){ state.io.disconnect(); }
      const sentinel = document.getElementById('sentinel');
      state.io = new IntersectionObserver((entries)=>{
        entries.forEach(e => { if(e.isIntersecting){ loadNextPage(); } });
      }, { rootMargin: '200px 0px' });
      state.io.observe(sentinel);
    }

    function computeTop(items){ return items.filter(x=> (x.rating||0)>=4).slice(0,30); }

    function renderAll(){
      const filtered = filterAndSort(state.items);
      // Headings depend on tab
      const isMovies = state.activeTab === 'movies';
      document.getElementById('topHeading').textContent = isMovies ? 'Top Rated Movies' : 'Top Rated Series';
      document.getElementById('allHeading').textContent = isMovies ? 'All Movies' : 'All Series';

      renderRow('rowTop', computeTop(filtered));
      state.filteredAll = filtered;
      resetGrid();
      if(state.filteredAll.length){ setupInfiniteScroll(); }
      populateFilterOptions();
    }

    function unique(values){ return Array.from(new Set(values.filter(Boolean))).sort(); }
    function populateFilterOptions(){
      const typeWant = state.activeTab === 'movies' ? 'movie' : 'series';
      const items = state.items.filter(x=> x.type===typeWant);
      const genres = unique(items.flatMap(x=> x.genres||[]));
      const years  = unique(items.map(x=> x.year));
      const gSel=document.getElementById('fGenre'); const ySel=document.getElementById('fYear');
      const gVal=gSel.value, yVal=ySel.value;
      gSel.innerHTML = '<option value="">All</option>'+genres.map(g=>`<option ${g===gVal?'selected':''}>${g}</option>`).join('');
      ySel.innerHTML = '<option value="">All</option>'+years.map(y=>`<option ${String(y)===String(yVal)?'selected':''}>${y}</option>`).join('');
    }

    /* ---------- Movie detail ---------- */
    function openMovieDetail(movie){
      const runtimeMin = Number(movie.runtime_min)||0;
      const runtimeHHMM = hhmmFromMinutes(runtimeMin);
      const percent = movieProgress(movie);
      const release = formatDateFromAny(movie.release_date);
      const posterFallback = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 600'%3E%3Crect width='100%25' height='100%25' fill='%230d0d0d'/%3E%3Ctext x='50%25' y='50%25' fill='%23bbb' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' font-size='20'%3ENo Image%3C/text%3E%3C/svg%3E";

      const panel = document.getElementById('moviePanel');
      panel.innerHTML = `
        <div class="detail-header">
          <h2 class="detail-title">${movie.title_en||''}</h2>
          <button class="detail-close" id="movieCloseBtn">Ã—</button>
        </div>

        <div class="detail-two-col">
          <div><img class="detail-poster" src="${movie.poster||posterFallback}" alt="Poster" onerror="this.src='${posterFallback}'"></div>
          <div>
            <div class="meta">
              <div class="row"><label>Original Title:</label><span>${movie.title_original||'â€”'}</span></div>
              <div class="row"><label>Release Date:</label><span>${release||'â€”'}</span></div>
              <div class="row"><label>Runtime:</label><span>${runtimeMin? runtimeMin+' min' : 'â€”'}</span></div>
              <div class="row"><label>Age Rating:</label><span>${movie.age_rating||'â€”'}</span></div>
              <div class="row"><label>Genres:</label><span>${(movie.genres||[]).join(', ')||'â€”'}</span></div>
              <div class="row"><label>Runtime (in HH:MM):</label><span>${runtimeMin? runtimeHHMM : 'â€”'}</span></div>
            </div>
            <div class="progress"><span style="width:${percent}%"></span></div>
            <div class="desc">${movie.short_description? movie.short_description : ''}</div>
          </div>
        </div>
      `;
      document.getElementById('movieOverlay').style.display='flex';
      document.body.classList.add('modal-open');
      document.getElementById('movieCloseBtn').addEventListener('click', ()=>{
        document.getElementById('movieOverlay').style.display='none';
        document.body.classList.remove('modal-open');
      });
    }

    /* ---------- Series detail ---------- */
    function openSeriesDetail(serie){
      document.getElementById('seriesHeader').innerHTML = `
        <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px;">
          <div>
            <h3 style="margin:0">${serie.title_en||''}</h3>
            <div class='muted'>${serie.title_original||''}</div>
          </div>
          <button class="detail-close" id="seriesCloseBtn">Ã—</button>
        </div>`;
      const bits = [String(serie.year||'').trim(), (serie.platform||'').trim(), (serie.episode_length_min? (serie.episode_length_min+" min") : ''), (serie.series_status||'').trim()].filter(Boolean);
      document.getElementById('seriesMeta').textContent = bits.join(' â€¢ ');
      document.getElementById('seriesBar').style.width = seriesGlobalProgress(serie).percent+"%";
      document.getElementById('seriesDesc').textContent = serie.short_description || '';

      const host = document.getElementById('seasonsHost'); host.innerHTML='';
      (serie.seasons||[]).forEach(season=>{
        const prog = seasonProgress(season);
        const box = document.createElement('div');
        box.style.border='1px solid var(--border)'; box.style.borderRadius='12px'; box.style.padding='10px'; box.style.margin='10px 0';
        box.innerHTML = `<div style='display:flex;align-items:center;gap:8px'><strong>Season ${season.season_number}</strong><span class='muted'>${prog.watched}/${prog.total} eps</span><div class='progress' style='flex:1;max-width:200px'><span style='width:${prog.percent}%'></span></div></div>`;
        (season.episodes||[]).forEach(ep=>{
          const row = document.createElement('div'); row.className='ep';
          row.innerHTML = `<code>${ep.code}</code> <span>${ep.title||''}</span> <span class='muted'>${formatDateFromAny(ep.air_date)}</span>`;
          box.appendChild(row);
        });
        host.appendChild(box);
      });
      document.getElementById('seriesOverlay').style.display='flex';
      document.body.classList.add('modal-open');
      document.getElementById('seriesCloseBtn').addEventListener('click', ()=>{
        document.getElementById('seriesOverlay').style.display='none';
        document.body.classList.remove('modal-open');
      });
    }

    // Backdrop close
    document.getElementById('movieOverlay').addEventListener('click', (e)=>{ if(e.target.id==='movieOverlay'){ e.currentTarget.style.display='none'; document.body.classList.remove('modal-open'); }});
    document.getElementById('seriesOverlay').addEventListener('click', (e)=>{ if(e.target.id==='seriesOverlay'){ e.currentTarget.style.display='none'; document.body.classList.remove('modal-open'); }});

    /* ---------- Tabs, Filters, Search ---------- */
    function setTab(tab){
      state.activeTab = tab; // 'movies' | 'series'
      document.getElementById('tabMovies').classList.toggle('active', tab==='movies');
      document.getElementById('tabSeries').classList.toggle('active', tab==='series');
      // rerender with new type scope
      renderAll();
    }
    document.getElementById('tabMovies').addEventListener('click', ()=> setTab('movies'));
    document.getElementById('tabSeries').addEventListener('click', ()=> setTab('series'));

    document.getElementById('fGenre').addEventListener('change', e=>{ state.filters.genre=e.target.value; renderAll(); });
    document.getElementById('fYear').addEventListener('change', e=>{ state.filters.year=e.target.value; renderAll(); });
    document.getElementById('sort').addEventListener('change', e=>{ state.sort=e.target.value; renderAll(); });
    document.getElementById('q').addEventListener('input', e=>{ state.query=e.target.value.toLowerCase(); renderAll(); });

    /* ---------- Start ---------- */
    fetchAll().catch(async err=>{
      console.warn('Firestore failed, falling back to sample-data.json', err);
      const res = await fetch('sample-data.json'); const json = await res.json();
      state.items = [ ...json.movies.map(m=>({...m, type:'movie'})), ...json.series.map(s=>({...s, type:'series'})) ];
      setTab('movies');
    });
  </script>
</body>
</html>
