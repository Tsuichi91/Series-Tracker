<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Watch Tracker ‚Ä¢ Dashboard</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    /* Tabs */
    .tabs{ display:flex; gap:8px; margin:12px 0; }
    .tab-btn{ cursor:pointer; }
    .tab-btn.active{ border-color:var(--accent); box-shadow:0 0 0 2px rgba(45,212,191,.18) inset; }
    .tab-pane{ display:none; }
    .tab-pane.active{ display:block; }

    /* Grid */
    .dash-grid{
      display:grid; gap:16px;
      grid-template-columns: repeat(12, 1fr);
    }
    .dash-col-3{ grid-column: span 3; }
    .dash-col-4{ grid-column: span 4; }
    .dash-col-5{ grid-column: span 5; }
    .dash-col-6{ grid-column: span 6; }
    .dash-col-8{ grid-column: span 8; }
    .dash-col-12{ grid-column: span 12; }
    @media (max-width: 1000px){
      .dash-col-3,.dash-col-4,.dash-col-5,.dash-col-6,.dash-col-8,.dash-col-12{ grid-column: 1 / -1; }
    }

    .card-pad{ padding:16px 18px; }
    .big-num{ font-size:2rem; font-weight:800; letter-spacing:.5px }
    .muted-sm{ color:var(--muted); font-size:.9rem }
    .kpi-grid{ display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:10px }
    .kpi{ background:var(--chip); border:1px solid var(--border); border-radius:12px; padding:12px }

    /* Bar rows */
    .stat-row{ display:flex; align-items:center; gap:10px; padding:6px 0 }
    .stat-row .label{ flex:0 0 180px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .stat-row .bar{ flex:1; height:8px; background:#161616; border:1px solid var(--border); border-radius:999px; overflow:hidden }
    .stat-row .bar > span{ display:block; height:100%; background:var(--accent); width:0 }
    .stat-row .val{ flex:0 0 auto; min-width:60px; text-align:right; }

    .stat-row.small .label{ flex-basis:140px }

    /* Mini columns */
    .mini-bars{ display:flex; align-items:flex-end; gap:4px; height:80px; }
    .mini-bars .col{ width:10px; background:var(--chip); border:1px solid var(--border); border-radius:4px; }
    .mini-legend{ display:flex; justify-content:space-between; margin-top:6px; color:var(--muted); font-size:.85rem }

    .stars{ font-size:1.1rem; letter-spacing:1px; }

    /* Next-up list */
    .list{ margin-top:8px }
    .list .item{ display:flex; gap:8px; padding:6px 0; border-bottom:1px solid var(--border) }
    .pill{ display:inline-flex; gap:6px; align-items:center; background:var(--chip); border:1px solid var(--border); padding:4px 8px; border-radius:999px }
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="logo"><span class="logo-icon"></span><span>Dashboard</span></div>
      <div class="spacer"></div>
      <a class="link-btn" href="index.html">üè† Overview</a>
      <a class="link-btn" href="admin.html">üõ† Admin</a>
    </div>
  </header>

  <main class="container">
    <!-- Tabs -->
    <div class="tabs">
      <button class="icon-btn tab-btn active" data-tab="movies">üé¨ Movies</button>
      <button class="icon-btn tab-btn" data-tab="series">üì∫ Series</button>
    </div>

    <!-- ==================== MOVIES TAB ==================== -->
    <div id="tab-movies" class="tab-pane active">
      <div class="dash-grid">
        <!-- KPIs -->
        <section class="card card-pad dash-col-6">
          <h2>Movies ‚Ä¢ Totals</h2>
          <div id="mTotals" class="muted">Loading‚Ä¶</div>
        </section>
        <section class="card card-pad dash-col-6">
          <h2>Average Rating</h2>
          <div id="mAvg" class="muted">Loading‚Ä¶</div>
        </section>

        <!-- Completion & Progress -->
        <section class="card card-pad dash-col-6">
          <h2>Completion Rate</h2>
          <div id="mCompletion"></div>
        </section>
        <section class="card card-pad dash-col-6">
          <h2>Progress Buckets</h2>
          <div id="mMovieBuckets"></div>
        </section>

        <!-- Ratings & Genres -->
        <section class="card card-pad dash-col-6">
          <h2>Rating Distribution</h2>
          <div id="mRatingHist"></div>
        </section>
        <section class="card card-pad dash-col-6">
          <h2>Avg Rating by Genre</h2>
          <div id="mAvgGenre"></div>
        </section>
        <section class="card card-pad dash-col-8">
          <h2>Top Genres (by Count)</h2>
          <div id="mGenres"></div>
        </section>
        <section class="card card-pad dash-col-4">
          <h2>Adds per Month (last 12)</h2>
          <div id="mAdds12"></div>
        </section>

        <!-- Years & Runtime -->
        <section class="card card-pad dash-col-6">
          <h2>Avg Rating by Year</h2>
          <div id="mAvgYear"></div>
        </section>
        <section class="card card-pad dash-col-6">
          <h2>Year Trend (by Count)</h2>
          <div id="mYearTrend"></div>
        </section>
        <section class="card card-pad dash-col-6">
          <h2>Runtime Histogram</h2>
          <div id="mRuntime"></div>
        </section>
        <section class="card card-pad dash-col-6">
          <h2>Watchtime ‚Ä¢ Seen & Remaining</h2>
          <div id="mWatchtime"></div>
        </section>
      </div>
    </div>

    <!-- ==================== SERIES TAB ==================== -->
    <div id="tab-series" class="tab-pane">
      <div class="dash-grid">
        <!-- KPIs -->
        <section class="card card-pad dash-col-6">
          <h2>Series ‚Ä¢ Totals</h2>
          <div id="sTotals" class="muted">Loading‚Ä¶</div>
        </section>
        <section class="card card-pad dash-col-6">
          <h2>Average Rating</h2>
          <div id="sAvg" class="muted">Loading‚Ä¶</div>
        </section>

        <!-- Progress & Backlog -->
        <section class="card card-pad dash-col-8">
          <h2>Series Progress & Next Up</h2>
          <div id="sProgress"></div>
        </section>
        <section class="card card-pad dash-col-4">
          <h2>Backlog & Plan</h2>
          <div id="sBacklog"></div>
        </section>

        <!-- Ratings, Genres, Platforms -->
        <section class="card card-pad dash-col-6">
          <h2>Rating Distribution</h2>
          <div id="sRatingHist"></div>
        </section>
        <section class="card card-pad dash-col-6">
          <h2>Avg Rating by Genre</h2>
          <div id="sAvgGenre"></div>
        </section>
        <section class="card card-pad dash-col-8">
          <h2>Top Genres (by Count)</h2>
          <div id="sGenres"></div>
        </section>
        <section class="card card-pad dash-col-4">
          <h2>Platforms</h2>
          <div id="sPlatforms"></div>
        </section>

        <!-- Trends -->
        <section class="card card-pad dash-col-6">
          <h2>Adds per Month (last 12)</h2>
          <div id="sAdds12"></div>
        </section>
        <section class="card card-pad dash-col-6">
          <h2>Avg Rating by Year</h2>
          <div id="sAvgYear"></div>
        </section>
        <section class="card card-pad dash-col-6">
          <h2>Year Trend (by Count)</h2>
          <div id="sYearTrend"></div>
        </section>

        <!-- Length, Seasons, Completion, Watchtime -->
        <section class="card card-pad dash-col-6">
          <h2>Episode Length</h2>
          <div id="sEpLen"></div>
        </section>
        <section class="card card-pad dash-col-6">
          <h2>Seasons per Series</h2>
          <div id="sSeasonsDist"></div>
        </section>
        <section class="card card-pad dash-col-6">
          <h2>Completion Rate</h2>
          <div id="sCompletion"></div>
        </section>
        <section class="card card-pad dash-col-6">
          <h2>Watchtime ‚Ä¢ Seen & Remaining</h2>
          <div id="sWatchtime"></div>
        </section>
      </div>
    </div>
  </main>

  <div class="toast" id="toast"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // ---------- Config ----------
    async function loadConfig(){
      for (const p of ["firebase.config.json","firebase.config.example.json"]) {
        try { const r = await fetch(p); if(r.ok) return r.json(); } catch(e) {}
      }
      throw new Error("Missing firebase.config.json");
    }
    const cfg = await loadConfig();
    const app = initializeApp(cfg);
    const db  = getFirestore(app);

    // ---------- Tabs ----------
    document.querySelectorAll('.tab-btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.tab-btn').forEach(b=> b.classList.remove('active'));
        document.querySelectorAll('.tab-pane').forEach(p=> p.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('tab-'+btn.dataset.tab).classList.add('active');
      });
    });

    // ---------- Helpers ----------
    const num   = (n)=> new Intl.NumberFormat().format(n||0);
    const clamp = (v,min,max)=> Math.max(min, Math.min(max, v));
    const pct   = (a,b)=> b>0 ? Math.round((a/b)*100) : 0;
    const starsLine = (v)=> {
      const r = Math.round(v||0);
      return '‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ'.slice(0,r)+'‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ'.slice(r);
    };
    const pad2 = (v)=> String(v).padStart(2,'0');
    const toDate = (v)=>{
      if(!v && v!==0) return null;
      if (typeof v === 'object' && typeof v.seconds === 'number') return new Date(v.seconds*1000);
      const d = new Date(v);
      return isNaN(d) ? null : d;
    };
    const monthKey = (d)=> `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
    const hhmm = (minutes)=>{
      const m = Math.max(0, Math.round(minutes||0));
      const h = Math.floor(m/60), mm = m%60;
      return `${h} h ${pad2(mm)} min`;
    };

    // ---------- Fetch ----------
    async function fetchAll(){
      const out = { movies:[], series:[] };
      for (const name of ["movies","series"]) {
        try{
          const snap = await getDocs(query(collection(db, name), orderBy("updated_at","desc")));
          snap.forEach(d=> out[name].push({ id:d.id, ...d.data() }));
        }catch{
          const snap = await getDocs(collection(db, name));
          snap.forEach(d=> out[name].push({ id:d.id, ...d.data() }));
        }
      }
      return out;
    }

    // ---------- Aggregations: Movies ----------
    function computeMovieStats(movies){
      const count = movies.length;
      const fav = movies.filter(x=> x.favorite).length;
      const wl  = movies.filter(x=> x.on_watchlist).length;

      const rated = movies.filter(x=> (x.rating||0)>0);
      const avg = rated.length ? rated.reduce((s,x)=> s+(x.rating||0),0)/rated.length : 0;

      const completed = movies.filter(x=>{
        const s = (x.status||'').toLowerCase();
        return ['completed','finished','watched','done'].includes(s);
      }).length;
      const plan = movies.filter(x=> (x.status||'').toLowerCase().includes('plan')).length;

      // watchtime / progress
      let seenMin=0, remainingMin=0;
      const progBuckets = { '<25%':0, '25‚Äì74%':0, '75‚Äì99%':0, 'Completed':0 };
      const started = movies.filter(x=> (x.status||'').toLowerCase()!=='plan to watch').length || 0;

      function progressPercent(m){
        const status = (m.status||'').toLowerCase();
        if(['completed','finished','watched','done'].includes(status)) return 100;
        const dur = (Number(m.runtime_min)||0)*60;
        const pos = Number(m.last_position_seconds)||0;
        if(dur<=0) return 0;
        return clamp(Math.round((pos/dur)*100), 0, 100);
      }

      movies.forEach(m=>{
        const dur = Number(m.runtime_min)||0; if(dur<=0) return;
        const posMin = (Number(m.last_position_seconds)||0)/60;
        const status = (m.status||'').toLowerCase();
        const seen = (['completed','finished','watched','done'].includes(status) || (posMin/dur)>=0.95) ? dur : Math.min(dur, posMin);
        seenMin += seen;
        remainingMin += Math.max(0, dur - seen);

        const p = progressPercent(m);
        if(p>=100) progBuckets['Completed']++;
        else if(p>=75) progBuckets['75‚Äì99%']++;
        else if(p>=25) progBuckets['25‚Äì74%']++;
        else progBuckets['<25%']++;
      });

      // genres count + avg
      const genreCount = {};
      const gSum={}, gN={};
      movies.forEach(x=>{
        (x.genres||[]).forEach(g=>{
          const k = String(g).trim(); if(!k) return;
          genreCount[k] = (genreCount[k]||0)+1;
          const r = Number(x.rating)||0; if(r>0){ gSum[k]=(gSum[k]||0)+r; gN[k]=(gN[k]||0)+1; }
        });
      });
      const genreAvg = Object.fromEntries(Object.keys(gSum).map(k=> [k, gSum[k]/gN[k]]));

      // ratings hist
      const hist = { 0:0, 1:0, 2:0, 3:0, 4:0, 5:0 };
      movies.forEach(x=>{ const r=Math.round(Number(x.rating)||0); if(r>=0 && r<=5) hist[r]++; });

      // year count + avg
      const yearCount = {};
      const ySum={}, yN={};
      movies.forEach(x=>{
        const y = Number(x.year)||0; if(y) yearCount[y]=(yearCount[y]||0)+1;
        const r = Number(x.rating)||0; if(y && r>0){ ySum[y]=(ySum[y]||0)+r; yN[y]=(yN[y]||0)+1; }
      });
      const yearAvg = Object.fromEntries(Object.keys(ySum).map(k=> [Number(k), ySum[k]/yN[k]]));

      // adds per month (12)
      const k12 = []; const now = new Date();
      for(let i=11;i>=0;i--){ const d=new Date(now.getFullYear(),now.getMonth()-i,1); k12.push(monthKey(d)); }
      const adds12 = Object.fromEntries(k12.map(k=> [k,0]));
      movies.forEach(x=>{
        const d = toDate(x.created_at) || toDate(x.updated_at);
        if(!d) return;
        const k = monthKey(new Date(d.getFullYear(),d.getMonth(),1));
        if(k in adds12) adds12[k] += 1;
      });

      // runtime buckets
      const runtime = { '‚â§90':0, '91‚Äì120':0, '121‚Äì150':0, '150+':0 };
      movies.forEach(x=>{
        const m = Number(x.runtime_min)||0; if(!m) return;
        if(m<=90) runtime['‚â§90']++; else if(m<=120) runtime['91‚Äì120']++; else if(m<=150) runtime['121‚Äì150']++; else runtime['150+']++;
      });

      return {
        totals: { movies:count, favorites:fav, watchlist:wl, completed, plan },
        avg,
        completion: { completed, started: started||count, rate: pct(completed, started||count) },
        progBuckets,
        ratingHist: hist,
        genres: genreCount,
        avgByGenre: genreAvg,
        years: yearCount,
        avgByYear: yearAvg,
        adds12,
        runtimeBuckets: runtime,
        watchtime: { seenMin, remainingMin, totalMin: seenMin+remainingMin }
      };
    }

    // ---------- Aggregations: Series ----------
    function computeSeriesStats(series){
      const count = series.length;
      const fav = series.filter(x=> x.favorite).length;
      const wl  = series.filter(x=> x.on_watchlist).length;

      const rated = series.filter(x=> (x.rating||0)>0);
      const avg = rated.length ? rated.reduce((s,x)=> s+(x.rating||0),0)/rated.length : 0;

      const completed = series.filter(x=>{
        const s = (x.status||'').toLowerCase();
        return ['completed','finished','watched','done'].includes(s);
      }).length;
      const plan = series.filter(x=> (x.status||'').toLowerCase().includes('plan')).length;

      // seasons/episodes & progress
      let totalEps=0, watchedEps=0;
      series.forEach(sr=>{
        (sr.seasons||[]).forEach(se=>{
          const eps = se.episodes||[];
          totalEps  += eps.length;
          watchedEps+= eps.filter(e=> e.watched).length;
        });
      });
      const seriesProgress = { watched: watchedEps, total: totalEps, percent: pct(watchedEps,totalEps) };

      // next-up
      const nextUp=[];
      series.forEach(sr=>{
        let found=null;
        (sr.seasons||[]).forEach(se=>{
          if(found) return;
          const first=(se.episodes||[]).find(e=> !e.watched);
          if(first){
            found = { title: sr.title_en||sr.id, code: first.code || `S${pad2(se.season_number||1)}E${pad2(first.episode_number||1)}`, when: first.air_date||'' };
          }
        });
        if(found) nextUp.push(found);
      });

      // genres/platforms
      const genreCount = {};
      const platformCount = {};
      const gSum={}, gN={};
      series.forEach(x=>{
        const p = String(x.platform||'').trim(); if(p) platformCount[p]=(platformCount[p]||0)+1;
        (x.genres||[]).forEach(g=>{
          const k=String(g).trim(); if(!k) return;
          genreCount[k]=(genreCount[k]||0)+1;
          const r=Number(x.rating)||0; if(r>0){ gSum[k]=(gSum[k]||0)+r; gN[k]=(gN[k]||0)+1; }
        });
      });
      const genreAvg = Object.fromEntries(Object.keys(gSum).map(k=> [k, gSum[k]/gN[k]]));

      // status distribution
      const statusCount={};
      series.forEach(x=>{
        const s=String(x.status||'').trim() || '‚Äî';
        statusCount[s]=(statusCount[s]||0)+1;
      });

      // ratings hist
      const hist={0:0,1:0,2:0,3:0,4:0,5:0};
      series.forEach(x=>{ const r=Math.round(Number(x.rating)||0); if(r>=0 && r<=5) hist[r]++; });

      // years & avg by year
      const yearCount={}; const ySum={}, yN={};
      series.forEach(x=>{
        const y=Number(x.year)||0; if(y) yearCount[y]=(yearCount[y]||0)+1;
        const r=Number(x.rating)||0; if(y && r>0){ ySum[y]=(ySum[y]||0)+r; yN[y]=(yN[y]||0)+1; }
      });
      const yearAvg = Object.fromEntries(Object.keys(ySum).map(k=> [Number(k), ySum[k]/yN[k]]));

      // adds per month
      const k12=[]; const now=new Date();
      for(let i=11;i>=0;i--){ const d=new Date(now.getFullYear(),now.getMonth()-i,1); k12.push(monthKey(d)); }
      const adds12=Object.fromEntries(k12.map(k=> [k,0]));
      series.forEach(x=>{
        const d=toDate(x.created_at) || toDate(x.updated_at);
        if(!d) return;
        const k=monthKey(new Date(d.getFullYear(),d.getMonth(),1));
        if(k in adds12) adds12[k]+=1;
      });

      // episode length buckets
      const lenBuckets={'‚â§25':0,'26‚Äì45':0,'46‚Äì60':0,'60+':0};
      series.forEach(s=>{
        const l=Number(s.episode_length_min)||0; if(!l) return;
        if(l<=25) lenBuckets['‚â§25']++; else if(l<=45) lenBuckets['26‚Äì45']++; else if(l<=60) lenBuckets['46‚Äì60']++; else lenBuckets['60+']++;
      });

      // seasons per series buckets
      const seaBuckets={'1':0,'2‚Äì3':0,'4‚Äì6':0,'7+':0};
      series.forEach(s=>{
        const n=(s.seasons||[]).length;
        if(n<=1) seaBuckets['1']++; else if(n<=3) seaBuckets['2‚Äì3']++; else if(n<=6) seaBuckets['4‚Äì6']++; else seaBuckets['7+']++;
      });

      // watchtime (minutes)
      let seenMin=0, remainingMin=0;
      series.forEach(s=>{
        const len=Number(s.episode_length_min)||0; if(len<=0) return;
        let t=0,w=0; (s.seasons||[]).forEach(se=>{ const eps=se.episodes||[]; t+=eps.length; w+=eps.filter(e=>e.watched).length; });
        seenMin += w*len;
        remainingMin += Math.max(0,(t-w)*len);
      });

      const started = series.filter(x=> (x.status||'').toLowerCase()!=='plan to watch').length || 0;

      return {
        totals:{ series:count, favorites:fav, watchlist:wl, seasons: series.reduce((a,x)=> a+(x.seasons||[]).length,0),
                 episodes: series.reduce((a,x)=> a+(x.seasons||[]).reduce((b,se)=> b+(se.episodes||[]).length,0),0),
                 completed, plan },
        avg,
        seriesProgress,
        nextUp,
        platforms: platformCount,
        statusCount,
        ratingHist: hist,
        genres: genreCount,
        avgByGenre: genreAvg,
        years: yearCount,
        avgByYear: yearAvg,
        adds12,
        lenBuckets,
        seaBuckets,
        completion: { completed, started: started||count, rate: pct(completed, started||count) },
        watchtime:{ seenMin, remainingMin, totalMin: seenMin+remainingMin }
      };
    }

    // ---------- Render ----------
    const fmt1 = (v)=> (Math.round((v||0)*10)/10).toFixed(1);

    function renderKPIsMovies(el,t){
      el.innerHTML = `
        <div class="kpi-grid">
          <div class="kpi"><div class="big-num">${num(t.movies)}</div><div class="muted-sm">Movies</div></div>
          <div class="kpi"><div class="big-num">${num(t.favorites)}</div><div class="muted-sm">Favorites</div></div>
          <div class="kpi"><div class="big-num">${num(t.watchlist)}</div><div class="muted-sm">On Watchlist</div></div>
        </div>
        <div class="muted-sm" style="margin-top:8px">Completed: <strong>${num(t.completed)}</strong> ‚Ä¢ Plan to Watch: <strong>${num(t.plan)}</strong></div>
      `;
    }
    function renderKPIsSeries(el,t){
      el.innerHTML = `
        <div class="kpi-grid">
          <div class="kpi"><div class="big-num">${num(t.series)}</div><div class="muted-sm">Series</div></div>
          <div class="kpi"><div class="big-num">${num(t.seasons)}</div><div class="muted-sm">Seasons</div></div>
          <div class="kpi"><div class="big-num">${num(t.episodes)}</div><div class="muted-sm">Episodes</div></div>
        </div>
        <div class="kpi-grid" style="margin-top:10px">
          <div class="kpi"><div class="big-num">${num(t.favorites)}</div><div class="muted-sm">Favorites</div></div>
          <div class="kpi"><div class="big-num">${num(t.watchlist)}</div><div class="muted-sm">On Watchlist</div></div>
          <div class="kpi"><div class="big-num">${num(t.completed)}</div><div class="muted-sm">Completed</div></div>
        </div>
        <div class="muted-sm" style="margin-top:8px">Plan to Watch: <strong>${num(t.plan)}</strong></div>
      `;
    }

    function renderAvg(el, v){
      el.innerHTML = `
        <div>
          <div class="big-num">${fmt1(v)}</div>
          <div class="stars" aria-hidden="true">${starsLine(v)}</div>
          <div class="muted-sm">Average rating</div>
        </div>
      `;
    }

    function renderCompletionSingle(el, c){
      el.innerHTML = `
        <div class="stat-row">
          <div class="label">Completed</div>
          <div class="bar"><span style="width:${c.rate}%"></span></div>
          <div class="val">${c.rate}%</div>
        </div>
        <div class="muted-sm">Completed ${num(c.completed)} / Started ${num(c.started)}</div>
      `;
    }

    function renderProgress(el, progress, nextUp){
      el.innerHTML = `
        <div class="stat-row">
          <div class="label">Overall Progress</div>
          <div class="bar"><span style="width:${progress.percent}%"></span></div>
          <div class="val">${progress.percent}%</div>
        </div>
        <div class="muted-sm">${num(progress.watched)} / ${num(progress.total)} episodes watched</div>
        <div class="list" style="margin-top:10px">
          <div class="muted" style="margin-bottom:6px">Next up</div>
          ${nextUp.slice(0,6).map(n=>`
            <div class="item">
              <span class="pill">${n.code}</span>
              <div style="flex:1">${n.title}</div>
              <span class="muted-sm">${n.when? n.when:''}</span>
            </div>
          `).join('') || '<div class="muted">No upcoming episodes</div>'}
        </div>
      `;
    }

    function renderBacklog(el, totals, plan, progress){
      const open = Math.max(0, (progress.total||0) - (progress.watched||0));
      el.innerHTML = `
        <div class="kpi-grid">
          <div class="kpi"><div class="big-num">${num(open)}</div><div class="muted-sm">Open Episodes</div></div>
          <div class="kpi"><div class="big-num">${num(totals.watchlist)}</div><div class="muted-sm">On Watchlist</div></div>
          <div class="kpi"><div class="big-num">${num(plan)}</div><div class="muted-sm">Plan to Watch</div></div>
        </div>
      `;
    }

    function renderBarList(el, map, {limit=12}={}){
      const entries = Object.entries(map).sort((a,b)=> b[1]-a[1]).slice(0,limit);
      if(!entries.length){ el.innerHTML = '<div class="muted">No data</div>'; return; }
      const max = entries[0][1] || 1;
      el.innerHTML = entries.map(([label,val])=>`
        <div class="stat-row">
          <div class="label">${label}</div>
          <div class="bar"><span style="width:${clamp((val/max)*100, 4, 100)}%"></span></div>
          <div class="val">${num(val)}</div>
        </div>
      `).join('');
    }

    function renderBarListNumeric(el, map, {limit=12, digits=1, labelWidth=180}={}){
      const entries = Object.entries(map).sort((a,b)=> b[1]-a[1]).slice(0,limit);
      if(!entries.length){ el.innerHTML = '<div class="muted">No data</div>'; return; }
      const max = Math.max(...entries.map(([,v])=> v)) || 1;
      el.innerHTML = entries.map(([label,val])=>`
        <div class="stat-row small">
          <div class="label" style="flex-basis:${labelWidth}px">${label}</div>
          <div class="bar"><span style="width:${clamp((val/max)*100,4,100)}%"></span></div>
          <div class="val">${val.toFixed(digits)}</div>
        </div>
      `).join('');
    }

    function renderYearTrend(el, map){
      const years = Object.keys(map).map(Number).sort((a,b)=> a-b);
      if(!years.length){ el.innerHTML = '<div class="muted">No data</div>'; return; }
      const maxVal = Math.max(...years.map(y=> map[y]||0)) || 1;
      const cols = years.map(y=>{
        const h = Math.round(((map[y]||0)/maxVal) * 100);
        return `<div class="col" title="${y}: ${num(map[y]||0)}" style="height:${clamp(h,5,100)}%" aria-label="${y}: ${num(map[y]||0)}"></div>`;
      }).join('');
      el.innerHTML = `<div class="mini-bars">${cols}</div><div class="mini-legend"><span>${years[0]}</span><span>${years[years.length-1]}</span></div>`;
    }

    function renderAvgYear(el, map){
      const years = Object.keys(map).map(Number).sort((a,b)=> a-b);
      if(!years.length){ el.innerHTML = '<div class="muted">No data</div>'; return; }
      const cols = years.map(y=>{
        const v = map[y]||0; const h = clamp(Math.round((v/5)*100), 5, 100);
        return `<div class="col" title="${y}: ${v.toFixed(1)}‚òÖ" style="height:${h}%"></div>`;
      }).join('');
      el.innerHTML = `<div class="mini-bars">${cols}</div><div class="mini-legend"><span>${years[0]}</span><span>${years[years.length-1]}</span></div>`;
    }

    function renderRatingHistogram(el, hist){
      const entries = Object.entries(hist).map(([k,v])=> [Number(k), v]).sort((a,b)=> a[0]-b[0]);
      const max = Math.max(...entries.map(([,v])=> v)) || 1;
      el.innerHTML = entries.map(([stars,val])=>`
        <div class="stat-row">
          <div class="label">${stars}‚òÖ</div>
          <div class="bar"><span style="width:${clamp((val/max)*100,4,100)}%"></span></div>
          <div class="val">${num(val)}</div>
        </div>
      `).join('');
    }

    function renderRuntime(el, buckets){
      const entries = Object.entries(buckets);
      const max = Math.max(...entries.map(([,v])=> v)) || 1;
      el.innerHTML = entries.map(([label,val])=>`
        <div class="stat-row">
          <div class="label">${label} min</div>
          <div class="bar"><span style="width:${clamp((val/max)*100,4,100)}%"></span></div>
          <div class="val">${num(val)}</div>
        </div>
      `).join('');
    }

    function renderWatchtime(el, wt){
      const seenPct = pct(wt.seenMin, wt.totalMin||1);
      el.innerHTML = `
        <div class="kpi-grid">
          <div class="kpi"><div class="big-num">${hhmm(wt.seenMin)}</div><div class="muted-sm">Seen</div></div>
          <div class="kpi"><div class="big-num">${hhmm(wt.remainingMin)}</div><div class="muted-sm">Remaining</div></div>
          <div class="kpi"><div class="big-num">${hhmm(wt.totalMin)}</div><div class="muted-sm">Total</div></div>
        </div>
        <div class="stat-row" style="margin-top:10px">
          <div class="label">Overall</div>
          <div class="bar"><span style="width:${seenPct}%"></span></div>
          <div class="val">${seenPct}%</div>
        </div>
      `;
    }

    // ---------- Run ----------
    function showToast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',1500); }

    (async ()=>{
      try{
        const {movies, series} = await fetchAll();

        // Movies
        const m = computeMovieStats(movies);
        renderKPIsMovies(document.getElementById('mTotals'), m.totals);
        renderAvg(document.getElementById('mAvg'), m.avg);
        renderCompletionSingle(document.getElementById('mCompletion'), m.completion);
        renderBarList(document.getElementById('mMovieBuckets'), m.progBuckets, {limit:4});
        renderRatingHistogram(document.getElementById('mRatingHist'), m.ratingHist);
        renderBarListNumeric(document.getElementById('mAvgGenre'), m.avgByGenre, {limit:12, digits:1, labelWidth:160});
        renderBarList(document.getElementById('mGenres'), m.genres, {limit:14});
        renderAvgYear(document.getElementById('mAvgYear'), m.avgByYear);
        renderYearTrend(document.getElementById('mYearTrend'), m.years);
        renderRuntime(document.getElementById('mRuntime'), m.runtimeBuckets);
        renderWatchtime(document.getElementById('mWatchtime'), m.watchtime);
        renderAdds12(document.getElementById('mAdds12'), m.adds12);

        // Series
        const s = computeSeriesStats(series);
        renderKPIsSeries(document.getElementById('sTotals'), s.totals);
        renderAvg(document.getElementById('sAvg'), s.avg);
        renderProgress(document.getElementById('sProgress'), s.seriesProgress, s.nextUp);
        renderBacklog(document.getElementById('sBacklog'), s.totals, s.totals.plan, s.seriesProgress);
        renderRatingHistogram(document.getElementById('sRatingHist'), s.ratingHist);
        renderBarListNumeric(document.getElementById('sAvgGenre'), s.avgByGenre, {limit:12, digits:1, labelWidth:160});
        renderBarList(document.getElementById('sGenres'), s.genres, {limit:14});
        renderBarList(document.getElementById('sPlatforms'), s.platforms, {limit:10});
        renderAdds12(document.getElementById('sAdds12'), s.adds12);
        renderAvgYear(document.getElementById('sAvgYear'), s.avgByYear);
        renderYearTrend(document.getElementById('sYearTrend'), s.years);
        renderRuntime(document.getElementById('sEpLen'), s.lenBuckets);
        renderBarList(document.getElementById('sSeasonsDist'), s.seaBuckets, {limit:4});
        renderCompletionSingle(document.getElementById('sCompletion'), s.completion);
        renderWatchtime(document.getElementById('sWatchtime'), s.watchtime);
      }catch(err){
        console.warn('Firestore failed, falling back to sample-data.json', err);
        try{
          const res = await fetch('sample-data.json');
          const data = await res.json();
          // Movies
          const m = computeMovieStats(data.movies||[]);
          renderKPIsMovies(document.getElementById('mTotals'), m.totals);
          renderAvg(document.getElementById('mAvg'), m.avg);
          renderCompletionSingle(document.getElementById('mCompletion'), m.completion);
          renderBarList(document.getElementById('mMovieBuckets'), m.progBuckets, {limit:4});
          renderRatingHistogram(document.getElementById('mRatingHist'), m.ratingHist);
          renderBarListNumeric(document.getElementById('mAvgGenre'), m.avgByGenre, {limit:12, digits:1, labelWidth:160});
          renderBarList(document.getElementById('mGenres'), m.genres, {limit:14});
          renderAvgYear(document.getElementById('mAvgYear'), m.avgByYear);
          renderYearTrend(document.getElementById('mYearTrend'), m.years);
          renderRuntime(document.getElementById('mRuntime'), m.runtimeBuckets);
          renderWatchtime(document.getElementById('mWatchtime'), m.watchtime);
          renderAdds12(document.getElementById('mAdds12'), m.adds12);

          // Series
          const s = computeSeriesStats(data.series||[]);
          renderKPIsSeries(document.getElementById('sTotals'), s.totals);
          renderAvg(document.getElementById('sAvg'), s.avg);
          renderProgress(document.getElementById('sProgress'), s.seriesProgress, s.nextUp);
          renderBacklog(document.getElementById('sBacklog'), s.totals, s.totals.plan, s.seriesProgress);
          renderRatingHistogram(document.getElementById('sRatingHist'), s.ratingHist);
          renderBarListNumeric(document.getElementById('sAvgGenre'), s.avgByGenre, {limit:12, digits:1, labelWidth:160});
          renderBarList(document.getElementById('sGenres'), s.genres, {limit:14});
          renderBarList(document.getElementById('sPlatforms'), s.platforms, {limit:10});
          renderAdds12(document.getElementById('sAdds12'), s.adds12);
          renderAvgYear(document.getElementById('sAvgYear'), s.avgByYear);
          renderYearTrend(document.getElementById('sYearTrend'), s.years);
          renderRuntime(document.getElementById('sEpLen'), s.lenBuckets);
          renderBarList(document.getElementById('sSeasonsDist'), s.seaBuckets, {limit:4});
          renderCompletionSingle(document.getElementById('sCompletion'), s.completion);
          renderWatchtime(document.getElementById('sWatchtime'), s.watchtime);

          showToast('Using sample data');
        }catch(e){
          document.getElementById('mTotals').textContent = 'Failed to load data.';
          document.getElementById('sTotals').textContent = 'Failed to load data.';
        }
      }
    })();

    // small helper to render monthly adds
    function renderAdds12(el, map){
      const keys = Object.keys(map);
      if(!keys.length){ el.innerHTML = '<div class="muted">No data</div>'; return; }
      const max = Math.max(...keys.map(k=> map[k]||0)) || 1;
      const cols = keys.map(k=>{
        const h = clamp(Math.round((map[k]/max)*100), 5, 100);
        return `<div class="col" title="${k}: ${num(map[k]||0)}" style="height:${h}%"></div>`;
      }).join('');
      el.innerHTML = `<div class="mini-bars">${cols}</div><div class="mini-legend"><span>${keys[0]}</span><span>${keys[keys.length-1]}</span></div>`;
    }
  </script>
</body>
</html>
